<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CotaÃ§Ã£o Drogasil V45</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #a3c1ad; }
        #tela-login-geral { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1b5e20; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .box-login { background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; }
        input { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-entrar { width: 100%; background: #1b5e20; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #app-body { display: none; padding: 10px; padding-top: 70px; padding-bottom: 120px; }
        .btn-adm-lock { position: fixed; top: 15px; left: 15px; background: rgba(0,0,0,0.3); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; z-index: 1000; }
        
        /* HEADER ADM REESTRUTURADO */
        .header-adm { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fff; padding: 10px; z-index: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .menu-exportar { position: relative; display: inline-block; flex: 1; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; overflow: hidden; }
        .dropdown-content button { color: black; padding: 12px 16px; text-decoration: none; display: block; border: none; width: 100%; text-align: left; background: white; cursor: pointer; font-size: 14px; }
        .dropdown-content button:hover { background-color: #f1f1f1; }
        .menu-exportar:hover .dropdown-content { display: block; }

        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-box { width: 100%; height: 150px; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fafafa; margin: 10px 0; overflow: hidden; }
        .img-box img { max-width: 100%; max-height: 100%; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .label { font-size: 11px; font-weight: bold; color: #1b5e20; margin-bottom: 4px; display: block; }
        .badge-porcentagem { display: block; font-size: 12px; font-weight: bold; margin-top: 5px; padding: 4px; border-radius: 4px; text-align: center; }
        .mais-caro { background: #ffebee; color: #c62828; }
        .mais-barato { background: #e8f5e9; color: #2e7d32; }
        .neutro { background: #f5f5f5; color: #666; }
        .tipo-preco { display: flex; gap: 5px; margin-top: 5px; }
        .btn-t { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #fff; font-size: 11px; font-weight: bold; }
        .btn-t.active { background: #1b5e20; color: #fff; }
        .lmpm-row { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .btn-opt { padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; }
        .btn-opt.active-sim { background: #2e7d32; color: white; }
        .btn-opt.active-nao { background: #d32f2f; color: white; }
        .aba-descendo { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #2e7d32; }
        .btn-add { display: none; width: 90%; background: #1b5e20; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; position: fixed; bottom: 20px; left: 5%; z-index: 999; }
    </style>
</head>
<body>

<div id="tela-login-geral">
    <div class="box-login">
        <h2 style="color:#1b5e20">Drogasil</h2>
        <input type="text" id="u-login" placeholder="UsuÃ¡rio">
        <input type="password" id="s-login" placeholder="Senha">
        <button class="btn-entrar" onclick="verificarLogin()">ENTRAR NO SITE</button>
    </div>
</div>

<div id="app-body">
    <button class="btn-adm-lock" onclick="pedirSenhaAdm()">ðŸ”’</button>
    
    <div class="header-adm" id="headerAdm">
        <div style="display:flex; gap:5px;">
            <div class="menu-exportar">
                <button style="width:100%; background:#2c3e50; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">EXPORTAR â–¼</button>
                <div class="dropdown-content">
                    <button onclick="baixarPDF()">ðŸ“„ Gerar PDF</button>
                    <button onclick="baixarExcel()">ðŸ“Š Gerar Excel</button>
                </div>
            </div>
            
            <button onclick="limparTudo()" style="flex:1; background:#c0392b; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">LIMPAR</button>
            <button onclick="location.reload()" style="padding:10px; border:none; border-radius:8px; background:#ddd;">SAIR</button>
        </div>
    </div>

    <div id="lista"></div>
    <button class="btn-add" id="btnAdd" onclick="add()">+ NOVO PRODUTO</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDuXw3AMPIjX1N3h2RWRo7APBjes_74peI",
  authDomain: "cotacao-drogasil.firebaseapp.com",
  projectId: "cotacao-drogasil",
  storageBucket: "cotacao-drogasil.firebasestorage.app",
  messagingSenderId: "293430041166",
  appId: "1:293430041166:web:9fcb3236547e0407c0011f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let itens = [];
let isAdmin = false;

function verificarLogin() {
    const u = document.getElementById('u-login').value;
    const s = document.getElementById('s-login').value;
    if(u === "Drogasil" && s === "Drogasil123") {
        document.getElementById('tela-login-geral').style.display = 'none';
        document.getElementById('app-body').style.display = 'block';
        carregar();
    } else { alert("Login Incorreto!"); }
}

function pedirSenhaAdm() {
    const s = prompt("Senha ADM:");
    if(s === "Drogasil@123") {
        isAdmin = true;
        document.getElementById('headerAdm').style.display = 'block';
        document.getElementById('btnAdd').style.display = 'block';
        render();
    }
}

async function carregar() {
    const doc = await db.collection("cotacoes").doc("lista_v39").get();
    if (doc.exists) { itens = doc.data().dados || []; }
    render();
}

async function salvar() {
    await db.collection("cotacoes").doc("lista_v39").set({ dados: itens });
}

function calcularDiferenca(precoRD, precoConcorrente) {
    if(!precoRD || !precoConcorrente || precoRD <= 0) return { texto: '---', num: 0, classe: 'neutro' };
    const rd = parseFloat(precoRD);
    const conc = parseFloat(precoConcorrente);
    const dif = ((conc / rd) - 1) * 100;
    if(dif > 0) return { texto: `+${dif.toFixed(1)}% caro`, num: dif.toFixed(1), classe: 'mais-caro' };
    if(dif < 0) return { texto: `${dif.toFixed(1)}% barato`, num: dif.toFixed(1), classe: 'mais-barato' };
    return { texto: 'Igual', num: 0, classe: 'neutro' };
}

function render() {
    const d = document.getElementById('lista'); d.innerHTML = '';
    itens.forEach((p, i) => {
        const lock = isAdmin ? '' : 'disabled';
        const difInfo = calcularDiferenca(p.meu, p.o);
        d.innerHTML += `
            <div class="card">
                <input type="text" ${lock} value="${p.desc}" onchange="itens[${i}].desc=this.value;salvar()" placeholder="Produto" style="font-weight:bold">
                <div class="img-box" onclick="${isAdmin ? `document.getElementById('f${i}').click()` : ''}">
                    ${p.foto ? `<img src="${p.foto}">` : '<span>FOTO</span>'}
                </div>
                <input type="file" id="f${i}" style="display:none" onchange="subirFoto(${i}, this)">
                <div class="row">
                    <div class="col">
                        <span class="label">RD</span>
                        <input type="number" step="0.01" ${lock} value="${p.meu}" onchange="itens[${i}].meu=this.value;salvar();render()">
                    </div>
                    <div class="col">
                        <span class="label" style="color:#c62828">CONCORRENTE</span>
                        <input type="number" step="0.01" value="${p.o}" onchange="itens[${i}].o=this.value;salvar();render()">
                        <div class="badge-porcentagem ${difInfo.classe}">${difInfo.texto}</div>
                        <div class="tipo-preco">
                            <button class="btn-t ${p.tipo==='PN'?'active':''}" onclick="itens[${i}].tipo='PN';salvar();render()">PN</button>
                            <button class="btn-t ${p.tipo==='PP'?'active':''}" onclick="itens[${i}].tipo='PP';salvar();render()">PP</button>
                        </div>
                    </div>
                </div>
                <div class="lmpm-row">
                    <span>LMPM?</span>
                    <div>
                        <button class="btn-opt ${p.lmpm==='S'?'active-sim':''}" onclick="itens[${i}].lmpm='S';salvar();render()">SIM</button>
                        <button class="btn-opt ${p.lmpm==='N'?'active-nao':''}" onclick="itens[${i}].lmpm='N';salvar();render()">NÃƒO</button>
                    </div>
                </div>
                ${p.lmpm === 'S' ? `
                    <div class="aba-descendo">
                        <div class="row">
                            <div class="col"><span class="label">QTD</span><input type="number" value="${p.qtd||0}" onchange="itens[${i}].qtd=this.value;salvar()"></div>
                            <div class="col"><span class="label">PREÃ‡O PROMO</span><input type="number" step="0.01" value="${p.pp||0}" onchange="itens[${i}].pp=this.value;salvar()"></div>
                        </div>
                    </div>
                ` : ''}
            </div>`;
    });
}

function add() {
    itens.push({desc:'', foto:null, meu:0, o:0, tipo:'PN', lmpm:'N', qtd:0, pp:0});
    render(); salvar();
}

function subirFoto(i, input) {
    const reader = new FileReader();
    reader.onload = e => { itens[i].foto = e.target.result; render(); salvar(); };
    reader.readAsDataURL(input.files[0]);
}

function limparTudo() { if(confirm('Limpar tudo?')){ itens=[]; render(); salvar(); } }

function baixarPDF() { 
    const element = document.getElementById('lista');
    html2pdf().from(element).save('CotaÃ§Ã£o_Drogasil.pdf'); 
}

function baixarExcel() {
    const dadosExcel = itens.map(p => {
        const dif = calcularDiferenca(p.meu, p.o);
        return {
            "Produto": p.desc,
            "PreÃ§o RD": p.meu,
            "PreÃ§o Concorrente": p.o,
            "DiferenÃ§a %": dif.num + "%",
            "Tipo": p.tipo,
            "LMPM": p.lmpm === 'S' ? "Sim" : "NÃ£o",
            "Qtd LMPM": p.qtd || 0,
            "PreÃ§o Promo LMPM": p.pp || 0
        };
    });
    const ws = XLSX.utils.json_to_sheet(dadosExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "CotaÃ§Ã£o");
    XLSX.utils.writeFile(wb, "CotaÃ§Ã£o_Drogasil.xlsx");
}
</script>
</body>
</html>
