<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CotaÃ§Ã£o V42 - Drogasil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #a3c1ad; padding-bottom: 120px; }
        .btn-adm-lock { position: fixed; top: 15px; right: 15px; background: rgba(0,0,0,0.3); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; z-index: 1000; }
        #modal-login { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 280px; text-align: center; }
        .login-box input { width: 100%; margin: 8px 0; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn-entrar { width: 100%; background: #1b5e20; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; }
        #app-content { padding: 10px; padding-top: 70px; }
        .header-adm { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fff; padding: 10px; z-index: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-box { width: 100%; height: 150px; margin: 10px 0; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fafafa; overflow: hidden; }
        .img-box img { max-width: 100%; max-height: 100%; }
        input { width: 100%; margin: 5px 0; padding: 12px; border: 1px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .row-flex { display: flex; gap: 10px; margin-top: 10px; }
        .col { flex: 1; }
        .label-p { font-size: 11px; font-weight: bold; color: #1b5e20; display: block; margin-bottom: 4px; }
        
        .tipo-preco { display: flex; gap: 5px; margin-top: 8px; }
        .btn-t { flex: 1; padding: 10px 5px; border: 2px solid #ddd; border-radius: 6px; background: #fff; font-size: 12px; font-weight: bold; cursor: pointer; color: #666; }
        .btn-t.active { background: #1b5e20; color: #fff; border-color: #1b5e20; }

        .lmpm-row { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .btn-opt { padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; background: #fff; font-weight: bold; cursor: pointer; flex: 1; max-width: 80px; text-align: center; }
        .btn-opt.active-sim { background: #2e7d32; color: white; border-color: #1b5e20; }
        .btn-opt.active-nao { background: #d32f2f; color: white; border-color: #b71c1c; }

        /* Estilo da Aba ExpansÃ­vel */
        .aba-lmpm { background: #f1f8e9; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #2e7d32; }

        .btn-add { display: none; width: 90%; background: #1b5e20; color: white; border: none; padding: 20px; border-radius: 15px; font-weight: bold; position: fixed; bottom: 20px; left: 5%; z-index: 999; box-shadow: 0 4px 15px rgba(0,0,0,0.4); font-size: 16px; }
    </style>
</head>
<body>

    <button class="btn-adm-lock" id="lockBtn" onclick="document.getElementById('modal-login').style.display='flex'">ðŸ”’</button>

    <div id="modal-login">
        <div class="login-box">
            <h3>Login ADM</h3>
            <input type="text" id="user" placeholder="UsuÃ¡rio">
            <input type="password" id="pass" placeholder="Senha">
            <button class="btn-entrar" onclick="login()">ENTRAR</button>
        </div>
    </div>

    <div id="app-content">
        <div class="header-adm" id="headerAdm">
            <div style="display: flex; gap: 5px;">
                <button onclick="baixarPDF()" style="flex:1; background:#2c3e50; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">PDF</button>
                <button onclick="limparBanco()" style="flex:1; background:#c0392b; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">LIMPAR</button>
                <button onclick="location.reload()" style="padding:12px; border:none; border-radius:8px; background:#ddd;">SAIR</button>
            </div>
        </div>
        <div id="lista"></div>
        <button class="btn-add" id="btnAdd" onclick="add()">+ ADICIONAR NOVO PRODUTO</button>
    </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDuXw3AMPIjX1N3h2RWRo7APBjes_74peI",
  authDomain: "cotacao-drogasil.firebaseapp.com",
  projectId: "cotacao-drogasil",
  storageBucket: "cotacao-drogasil.firebasestorage.app",
  messagingSenderId: "293430041166",
  appId: "1:293430041166:web:9fcb3236547e0407c0011f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let itens = [];
let isAdmin = false;

async function carregarDados() {
    try {
        const doc = await db.collection("cotacoes").doc("lista_v39").get();
        if (doc.exists) { itens = doc.data().dados || []; }
        render();
    } catch (e) { console.error(e); }
}

async function save() {
    try {
        await db.collection("cotacoes").doc("lista_v39").set({ dados: itens });
    } catch (e) { console.log("Erro ao salvar"); }
}

function login() {
    if(document.getElementById('user').value === "admdrogasil" && document.getElementById('pass').value === "Drogasil@123") {
        isAdmin = true;
        document.getElementById('lockBtn').style.display = 'none';
        document.getElementById('headerAdm').style.display = 'block';
        document.getElementById('btnAdd').style.display = 'block';
        document.getElementById('modal-login').style.display = 'none';
        render();
    } else { alert("Senha incorreta!"); }
}

function render() {
    const d = document.getElementById('lista'); 
    d.innerHTML = '';
    
    itens.forEach((p, i) => {
        const lock = isAdmin ? '' : 'disabled';
        d.innerHTML += `
            <div class="card">
                <input type="text" ${lock} onchange="itens[${i}].desc=this.value;save()" value="${p.desc||''}" placeholder="Nome do Produto" style="font-weight:bold; color:#1b5e20; border-bottom: 2px solid #1b5e20;">
                
                <div class="img-box" onclick="${isAdmin ? `document.getElementById('f${i}').click()` : ''}">
                    ${p.foto ? `<img src="${p.foto}">` : '<span style="color:#ccc; font-weight:bold;">FOTO DO PRODUTO</span>'}
                </div>
                <input type="file" id="f${i}" style="display:none" onchange="processarFoto(${i}, this)">
                
                <input type="text" ${lock} value="${p.sku||''}" onchange="itens[${i}].sku=this.value;save()" placeholder="CÃ³digo SKU / EAN">

                <div class="row-flex">
                    <div class="col">
                        <span class="label-p">VALOR RD</span>
                        <input type="number" step="0.01" ${lock} value="${p.meu}" onchange="itens[${i}].meu=this.value;save()">
                    </div>
                    <div class="col">
                        <span class="label-p" style="color:#b71c1c">CONCORRÃŠNCIA</span>
                        <input type="number" step="0.01" value="${p.o}" onchange="itens[${i}].o=this.value;save()">
                        <div class="tipo-preco">
                            <button class="btn-t ${p.tipo==='PN'?'active':''}" onclick="itens[${i}].tipo='PN';save();render()">PN</button>
                            <button class="btn-t ${p.tipo==='PP'?'active':''}" onclick="itens[${i}].tipo='PP';save();render()">PP</button>
                        </div>
                    </div>
                </div>

                <div class="lmpm-row">
                    <span style="font-weight:bold; font-size:16px; color:#333;">LMPM?</span>
                    <div style="display:flex; gap:10px; flex:1; justify-content: flex-end;">
                        <button class="btn-opt ${p.lmpm==='S'?'active-sim':''}" onclick="itens[${i}].lmpm='S';save();render()">SIM</button>
                        <button class="btn-opt ${p.lmpm==='N'?'active-nao':''}" onclick="itens[${i}].lmpm='N';save();render()">NÃƒO</button>
                    </div>
                </div>

                ${p.lmpm === 'S' ? `
                    <div class="aba-lmpm">
                        <div class="row-flex">
                            <div class="col">
                                <span class="label-p">QUANTIDADE</span>
                                <input type="number" value="${p.qtd_lmpm || 0}" onchange="itens[${i}].qtd_lmpm=this.value;save()" placeholder="Ex: 3">
                            </div>
                            <div class="col">
                                <span class="label-p">VALOR UN. PROMO</span>
                                <input type="number" step="0.01" value="${p.preco_promo || 0}" onchange="itens[${i}].preco_promo=this.value;save()" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${isAdmin ? `<button onclick="if(confirm('Excluir este produto?')){itens.splice(${i},1);save();render()}" style="color:red; border:none; background:none; width:100%; text-align:right; margin-top:20px; font-size:11px; font-weight:bold; cursor:pointer;">[ EXCLUIR PRODUTO ]</button>` : ''}
            </div>`;
    });
}

function add() {
    itens.push({desc:'', foto:null, sku:'', meu:0, o:0, tipo:'PN', lmpm:'N', qtd_lmpm:0, preco_promo:0});
    render(); 
    save();
    window.scrollTo(0, document.body.scrollHeight);
}

function processarFoto(i, input) {
    const reader = new FileReader();
    reader.onload = function(e) {
        itens[i].foto = e.target.result;
        render();
        save();
    };
    reader.readAsDataURL(input.files[0]);
}

function limparBanco() { if(confirm('Deseja apagar todos os produtos?')){ itens=[]; render(); save(); } }
function baixarPDF() { html2pdf().from(document.getElementById('lista')).save('Relatorio_Cotacao.pdf'); }

carregarDados();
</script>
</body>
</html>
