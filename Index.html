<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CotaÃ§Ã£o V39 - Drogasil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #a3c1ad; }
        .btn-adm-lock { position: fixed; top: 15px; right: 15px; background: rgba(0,0,0,0.3); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        #modal-login { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 280px; text-align: center; }
        .login-box input { width: 100%; margin: 8px 0; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .btn-entrar { width: 100%; background: #1b5e20; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; }
        #app-content { padding: 10px; padding-top: 70px; min-height: 100vh; }
        .header-adm { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fff; padding: 10px; z-index: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .card { background: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-box { position: relative; width: 100%; height: 160px; margin: 8px 0; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fdfdfd; overflow: hidden; }
        .img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        input { width: 100%; margin: 4px 0; padding: 10px; border: 1px solid #eee; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        /* Estilo para campos travados */
        input:disabled { background-color: #f5f5f5; color: #888; border: 1px solid #ddd; cursor: not-allowed; }
        
        .label-title { font-weight: bold; font-size: 11px; display: block; }
        .label-rd { color: #1b5e20; }
        .label-conc { color: #b71c1c; }
        .row-flex { display: flex; gap: 10px; align-items: flex-end; }
        .col { flex: 1; }
        .tipo-preco { display: flex; gap: 4px; margin-top: 2px; }
        .btn-p { flex: 1; font-size: 9px; padding: 4px 0; border: 1px solid #ddd; border-radius: 4px; background: #fff; font-weight: bold; color: #666; }
        .btn-p.active { background: #2c3e50; color: #fff; border-color: #2c3e50; }
        .lmpm-row { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; padding-top: 8px; border-top: 1px solid #f5f5f5; }
        .btn-opt { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; flex: 1; margin-left: 8px; font-size: 14px; }
        .btn-sim.active { background: #4caf50; color: white; border-color: #388e3c; }
        .btn-nao.active { background: #f44336; color: white; border-color: #d32f2f; }
        .aba-lmpm { background: #f1f8e9; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #4caf50; display: none; }
        .aba-lmpm.show { display: block; }
        .btn-add { width: 100%; background: #1b5e20; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 80px; display: none; }
    </style>
</head>
<body>

    <button class="btn-adm-lock" id="lockBtn" onclick="document.getElementById('modal-login').style.display='flex'">ðŸ”’</button>

    <div id="modal-login">
        <div class="login-box">
            <h3>Acesso Restrito ADM</h3>
            <input type="text" id="user" placeholder="UsuÃ¡rio">
            <input type="password" id="pass" placeholder="Senha">
            <button class="btn-entrar" onclick="login()">ENTRAR</button>
            <button onclick="document.getElementById('modal-login').style.display='none'" style="background:none; border:none; color:#666; margin-top:10px;">Voltar</button>
        </div>
    </div>

    <div id="app-content">
        <div class="header-adm" id="headerAdm">
            <div style="display: flex; gap: 5px;">
                <button onclick="baixarPDF()" style="flex:1; background:#2c3e50; color:white; border:none; padding:10px; border-radius:8px;">PDF</button>
                <button onclick="baixarExcel()" style="flex:1; background:#2c3e50; color:white; border:none; padding:10px; border-radius:8px;">EXCEL</button>
                <button onclick="limparBanco()" style="flex:1; background:#95a5a6; color:white; border:none; padding:10px; border-radius:8px;">LIMPAR</button>
                <button onclick="location.reload()" style="padding:10px; border-radius:8px; border:none;">SAIR</button>
            </div>
        </div>

        <div id="lista"></div>
        <button class="btn-add" id="btnAdd" onclick="add()">+ NOVO PRODUTO</button>
    </div>

<script>
    let db; let itens = []; let isAdmin = false;

    const request = indexedDB.open("Drogasil_V39_DB", 1);
    request.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("produtos", { keyPath: "id" }); };
    request.onsuccess = e => { db = e.target.result; carregarDados(); };

    function carregarDados() {
        const tx = db.transaction(["produtos"], "readonly");
        const store = tx.objectStore("produtos");
        const req = store.get("lista_v39");
        req.onsuccess = () => { itens = req.result ? req.result.dados : []; render(); };
    }

    function save() {
        const tx = db.transaction(["produtos"], "readwrite");
        const store = tx.objectStore("produtos");
        store.put({ id: "lista_v39", dados: itens });
        render();
    }

    function login() {
        if(document.getElementById('user').value === "admdrogasil" && document.getElementById('pass').value === "Drogasil@123") {
            isAdmin = true;
            document.getElementById('lockBtn').style.display = 'none';
            document.getElementById('headerAdm').style.display = 'block';
            document.getElementById('btnAdd').style.display = 'block';
            document.getElementById('modal-login').style.display = 'none';
            render();
        } else { alert("Senha Incorreta"); }
    }

    function render() {
        const d = document.getElementById('lista'); d.innerHTML = '';
        if(itens.length === 0 && !isAdmin) { d.innerHTML = '<p style="text-align:center; margin-top:50px;">Aguardando o administrador cadastrar produtos...</p>'; return; }

        itens.forEach((p, i) => {
            // ATENÃ‡ÃƒO: Se nÃ£o for ADMIN, o atributo "disabled" Ã© aplicado
            const lock = isAdmin ? '' : 'disabled';
            
            d.innerHTML += `
                <div class="card">
                    <input type="text" style="font-weight:bold; color:#1b5e20;" ${lock} onchange="itens[${i}].desc=this.value;save()" value="${p.desc||''}" placeholder="Nome do Produto">
                    
                    <div class="img-box" ${isAdmin ? `onclick="document.getElementById('f${i}').click()"` : 'style="cursor:default;"'}>
                        ${p.foto ? `<img src="${p.foto}">` : '<span style="color:#ccc; font-size:10px;">FOTO BLOQUEADA</span>'}
                    </div>
                    <input type="file" id="f${i}" accept="image/*" style="display:none" onchange="processarFoto(${i}, this)">
                    
                    <input type="text" ${lock} value="${p.sku||''}" onchange="itens[${i}].sku=this.value;save()" placeholder="CÃ³digo SKU">
                    
                    <div class="row-flex">
                        <div class="col">
                            <span class="label-title label-rd">VALOR RD</span>
                            <input type="number" step="0.01" ${lock} value="${p.meu}" onchange="itens[${i}].meu=this.value;save()">
                        </div>
                        <div class="col">
                            <span class="label-title label-conc">CONCORRÃŠNCIA</span>
                            <input type="number" step="0.01" value="${p.o}" onchange="itens[${i}].o=this.value;save()">
                            <div class="tipo-preco">
                                <button class="btn-p ${p.tipo==='PM'?'active':''}" onclick="itens[${i}].tipo='PM';save()">PM</button>
                                <button class="btn-p ${p.tipo==='PN'?'active':''}" onclick="itens[${i}].tipo='PN';save()">PN</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lmpm-row">
                        <span style="font-size:12px; font-weight:bold;">LMPM?</span>
                        <button class="btn-opt btn-sim ${p.lmpm==='Sim'?'active':''}" onclick="itens[${i}].lmpm='Sim';save()">Sim</button>
                        <button class="btn-opt btn-nao ${p.lmpm==='NÃ£o'?'active':''}" onclick="itens[${i}].lmpm='NÃ£o';save()">NÃ£o</button>
                    </div>

                    <div class="aba-lmpm ${p.lmpm==='Sim'?'show':''}">
                        <div class="row-flex">
                            <div class="col">
                                <small>Qtd MÃ­nima</small>
                                <input type="number" value="${p.l_qtd||''}" onchange="itens[${i}].l_qtd=this.value;save()" placeholder="Ex: 3">
                            </div>
                            <div class="col">
                                <small>Valor Desconto</small>
                                <input type="number" step="0.01" value="${p.l_val||''}" onchange="itens[${i}].l_val=this.value;save()" placeholder="0,00">
                            </div>
                        </div>
                    </div>
                    
                    ${isAdmin ? `<button onclick="itens.splice(${i},1);save()" style="color:red; background:none; border:none; font-size:10px; margin-top:10px; width:100%; text-align:right;">EXCLUIR PRODUTO</button>` : ''}
                </div>`;
        });
    }

    function processarFoto(i, input) {
        if (!isAdmin || !input.files[0]) return; // ProteÃ§Ã£o extra na funÃ§Ã£o de foto
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const max = 400; let w = img.width, h = img.height;
                if (w > h) { if (w > max) { h *= max / w; w = max; } } else { if (h > max) { w *= max / h; h = max; } }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                itens[i].foto = canvas.toDataURL('image/jpeg', 0.6); save();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function add() { if(isAdmin) { itens.push({desc:'', foto:null, sku:'', meu:'', o:'', lmpm:'', tipo:'', l_qtd:'', l_val:''}); save(); } }
    function limparBanco() { if(isAdmin && confirm('Limpar todo o banco de dados?')){ itens=[]; save(); } }
    function baixarPDF() { html2pdf().from(document.getElementById('lista')).save('Relatorio_CotaÃ§Ã£o.pdf'); }
    function baixarExcel() {
        const ws = XLSX.utils.json_to_sheet(itens.map(p=>({"Produto":p.desc,"SKU":p.sku,"Valor RD":p.meu,"Conc":p.o,"Tipo":p.tipo,"LMPM":p.lmpm,"Qtd":p.l_qtd,"Valor C/ Desc":p.l_val})));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "CotaÃ§Ã£o"); XLSX.writeFile(wb, "Relatorio.xlsx");
    }
</script>
</body>
</html>
